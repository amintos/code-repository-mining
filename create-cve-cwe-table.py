#!/usr/bin/env python3

import psycopg2
import config
import time
import re

from pymongo import MongoClient
from cpe     import CPE

createTableStatement ="""
CREATE TABLE cve_cwe_classification (
  cveid   VARCHAR(64),
  cweid   INTEGER
);
"""
insertStatement = "INSERT INTO cve_cwe_classification VALUES(%s,%s);"
dropTableStatement   = "DROP TABLE IF EXISTS cve_cwe_classification;"

postgresConnection = psycopg2.connect(dbname=config.postgresql.dbname,
                                      user=config.postgresql.user,
                                      password=config.postgresql.password)
postgresCursor = postgresConnection.cursor()

postgresCursor.execute(dropTableStatement)
postgresCursor.execute(createTableStatement)
postgresConnection.commit()

# set up MongoDB connection
mongoclient = MongoClient(config.mongodb.host, config.mongodb.port)
mongoCves   = mongoclient['cvedb']['cves']

# extract relevant data from every cve in the mongodb
# and write it into the newly created postgres table
cvecount = 0
for cve in mongoCves.find():
  if "cwe" not in cve:        continue
  if cve["cwe"] == "Unknown": continue

  cve_id     = cve["id"]
  parsed_cwe = cve["cwe"].replace("CWE-", "")
  row        = (cve_id,parsed_cwe)

  cvecount += 1

  try:
    postgresCursor.execute(insertStatement, row)
  except:
    postgresConnection.commit()
    time.sleep(0.2)
    postgresCursor.execute(insertStatement, row)

print("Inserted ", cvecount, " CVE-CWE pairings")

postgresConnection.commit()
postgresCursor.close()
postgresConnection.close()
